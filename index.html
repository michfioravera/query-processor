<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Query processor</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🚀</text></svg>">
    <link rel="stylesheet" href="style.css">
</head>
<body>
<script src="paramProcessor.js"></script>
<script>
// Registrazione del Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
        try {
            const registration = await navigator.serviceWorker.register('/sw.js');
            console.log('Service Worker registrato con successo:', registration);
        } catch (error) {
            console.error('Errore nella registrazione del Service Worker:', error);
        }
    });
}
</script>
    <div class="header">
        <h1>🚀</h1>
    </div>
    
    <div class="main-container">
        <div class="container">
            <h2>📝</h2>
            <div class="form-group">
                <label for="parameters">
                    <span id="liveIndicator" class="live-indicator" style="display: none;">
                        <span class="live-dot"></span>
                        🔄
                    </span>
                </label>
                
                <textarea id="parameters" placeholder="name=John Smith
scores=85,92,78,94,88
age=28
city=NewYork
temperatures=22.5,23.1,21.8,24.2,23.7
colors=red,green,blue,yellow
active=true
budget=1500.75"></textarea>

                
            </div>
            <!-- Query Parameters Info -->
            <div id="queryInfo" class="query-info">
            <div class="button-group">
                <button onclick="clearResults()" class="btn-secondary">
                    🗑️
                </button>
            </div>
        </div>

        <div class="container">
            <h2>📊</h2>
            
            <div id="urlDisplay" class="url-display" style="display: none;">
                    <strong>🔗</strong>
                    <div id="urlText" class="url-text"></div>
                </div>
            
            
                <strong>🔗</strong>
                <span id="queryStatus">❌</span>
            </div>
            <div class="button-group">
                <button onclick="clearResults()" class="btn-secondary">
                    🗑️
                </button>
                <button onclick="exportData()" class="btn-secondary">
                    📥
                </button>
            </div>
            
            <div id="result">✍️</div>
        </div>
    </div>
    
    

    <script>
        let lastResult = null;
        let processingTimeout = null;

        // Real-time processing function
        function processInRealTime() {
            const params = parseParameters();
            updateURL(params);
            updateQueryInfo(); // Aggiunto per aggiornare la sezione query info
            executeAnalysis(params);
        }

        // Debounced real-time processing
        function scheduleProcessing() {
            if (processingTimeout) {
                clearTimeout(processingTimeout);
            }
            
            const liveIndicator = document.getElementById('liveIndicator');
            liveIndicator.style.display = 'inline-flex';
            
            processingTimeout = setTimeout(() => {
                processInRealTime();
                liveIndicator.style.display = 'none';
            }, 300);
        }

        // Update URL in real-time
        function updateURL(params) {
            const baseURL = window.location.href.split('?')[0];
            const queryString = new URLSearchParams(params).toString();
            const newURL = queryString ? `${baseURL}?${queryString}` : baseURL;

            if (window.location.href !== newURL) {
                window.history.replaceState({}, '', newURL);
            }

            const urlDisplay = document.getElementById('urlDisplay');
            const urlText = document.getElementById('urlText');

            if (Object.keys(params).length > 0) {
                urlDisplay.style.display = 'block';

                const usp = new URLSearchParams();
                for (const [key, value] of Object.entries(params)) {
                    // ⚠️ Non toccare i valori: parseParameters() li ha già deduplicati
                    usp.append(key, value);
                }

                const apiURL = `/api?${usp.toString()}`;
                urlText.innerHTML = `<a href="${apiURL}" target="_blank" rel="noopener noreferrer">${apiURL}</a>`;
            } else {
                urlDisplay.style.display = 'none';
                urlText.innerHTML = '';
            }
        }

        // Read query parameters from URL
        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            const queryParams = {};
            
            for (let [key, value] of params) {
                queryParams[key] = value;
            }
            
            return queryParams;
        }

        // Update interface with query parameters
        function updateQueryInfo() {
            const queryParams = getQueryParams();
            const queryInfo = document.getElementById('queryInfo');
            const queryStatus = document.getElementById('queryStatus');
            
            if (Object.keys(queryParams).length === 0) {
                queryStatus.textContent = '❌';
                queryInfo.classList.remove('active');
            } else {
                const paramCount = Object.keys(queryParams).length;
                queryStatus.innerHTML = `✅ ${paramCount}`;
                queryInfo.classList.add('active');
            }
        }

        // Load parameters from query parameters
        function loadFromQuery() {
            const queryParams = new URLSearchParams(window.location.search);
            const entries = Object.entries(Object.fromEntries(queryParams.entries()));

            if (entries.length === 0) {
                alert('❌');
                return;
            }
            
            let paramText = '';
            for (let [key, value] of entries) {
                paramText += `${key}=${value}\n`;
            }

            const textarea = document.getElementById('parameters');
            textarea.value = paramText.trim();
            textarea.style.background = '#e8f5e8';
            setTimeout(() => {
                textarea.style.background = '';
            }, 500);

            // Process immediately
            processInRealTime();
        }

        function parseParameters() {
            const inputText = document.getElementById('parameters').value;
            return ParamProcessor.parseParametersFromInput(inputText);
        }

        async function executeAnalysis(params) {
            const resultElement = document.getElementById('result');
            
            if (Object.keys(params).length === 0) {
                resultElement.innerHTML = '<div style="color: #6c757d; text-align: center; padding: 20px;">✍️</div>';
                return;
            }

            try {
                const startTime = performance.now();
                const result = ParamProcessor.analyzeParameters(params, startTime);
                lastResult = result;
                
                // Format result with HTML
                const formattedResult = formatResultHTML(result);
                resultElement.innerHTML = formattedResult;
                
            } catch (error) {
                console.error('Analysis error:', error);
                resultElement.innerHTML = `<div style="color: #dc3545; text-align: center; padding: 20px;">❌ Error: ${error.message}</div>`;
            }
        }

          function formatResultHTML(data) {
              let html = '';
              
              // Header with performance
              html += `<div class="performance-info">`;
              html += `<strong>📈</strong><br>`;
              html += `⏱️ ${data.performance.responseTime} | `;
              html += `📊 ${data.performance.parameterCount}`;
              if (data.summary.multiValueParameters > 0) {
                  html += ` | 🔁 ${data.summary.multiValueParameters}`;
              }
              html += ` | 🕐 ${data.performance.timestamp}`;
              html += `</div>`;
              
              // Summary
              html += `<div class="result-section">`;
              html += `<strong>📋</strong><br>`;
              html += `📊 ${data.summary.totalParameters} | `;
              html += `🔢 ${data.summary.numericParameters} | `;
              html += `📝 ${data.summary.arrayParameters} | `;
              html += `✓ ${data.summary.booleanParameters}`;
              if (data.summary.multiValueParameters > 0) {
                  html += ` | 🔁 ${data.summary.multiValueParameters}`;
              }
              html += `</div>`;
              
              // Parameters
              for (const [key, info] of Object.entries(data.parameters)) {
                  html += `<div class="param-card">`;
                  html += `<div class="param-title">${key}`;
                  if (info.occurrences > 1) {
                      html += ` <span style="background: #2196f3; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">${info.occurrences} values</span>`;
                  }
                  html += `</div>`;
                  
                  if (info.occurrences === 1) {
                      // Singolo valore
                      html += `<div class="param-value">${info.value}</div>`;
                      html += `<div class="param-meta">`;
                      html += `<strong>🏷️</strong> ${info.type}`;
                      
                      if (info.analysis.isArray) {
                          html += ` (${info.elements.length})`;
                      }
                      
                      if (info.statistics) {
                          html += `<div class="stats-grid">`;
                          html += `<div class="stat-item"><span class="stat-value">${info.statistics.average.toFixed(2)}</span>📊</div>`;
                          html += `<div class="stat-item"><span class="stat-value">${info.statistics.median}</span>📍</div>`;
                          html += `<div class="stat-item"><span class="stat-value">${info.statistics.min}</span>⬇️</div>`;
                          html += `<div class="stat-item"><span class="stat-value">${info.statistics.max}</span>⬆️</div>`;
                          html += `<div class="stat-item"><span class="stat-value">${info.statistics.sum}</span>Σ</div>`;
                          html += `<div class="stat-item"><span class="stat-value">${info.statistics.standardDeviation.toFixed(2)}</span>📈</div>`;
                          html += `</div>`;
                      }
                  } else {
                      // Multi-valore
                      html += `<div class="param-meta"><strong>🏷️</strong> ${info.type}</div>`;
                      
                      // Mostra ogni valore
                      info.analyses.forEach((analysis, index) => {
                          html += `<div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px;">`;
                          html += `<div style="font-weight: 600; color: #495057; margin-bottom: 5px;">${index + 1}:</div>`;
                          html += `<div class="param-value" style="margin-bottom: 5px;">${analysis.value}</div>`;
                          html += `<div style="font-size: 0.9em; color: #6c757d;">🏷️ ${analysis.type}</div>`;
                          
                          if (analysis.elements) {
                              html += `<div style="font-size: 0.9em; color: #6c757d;">📝 ${analysis.elements.join(', ')}</div>`;
                          }
                          
                          if (analysis.statistics) {
                              html += `<div class="stats-grid" style="margin-top: 5px;">`;
                              html += `<div class="stat-item"><span class="stat-value">${analysis.statistics.average.toFixed(2)}</span>📊</div>`;
                              html += `<div class="stat-item"><span class="stat-value">${analysis.statistics.min}</span>⬇️</div>`;
                              html += `<div class="stat-item"><span class="stat-value">${analysis.statistics.max}</span>⬆️</div>`;
                              html += `</div>`;
                          }
                          
                          html += `</div>`;
                      });
                  }
                  
                  html += `</div></div>`;
              }
              
              return html;
          }

        function clearResults() {
            document.getElementById('parameters').value = '';
            document.getElementById('result').innerHTML = '✍️';
            document.getElementById('urlDisplay').style.display = 'none';
            lastResult = null;
            
            // Update URL
            window.history.replaceState({}, '', window.location.href.split('?')[0]);
            updateQueryInfo();
        }

        function exportData() {
            if (!lastResult) {
                alert('❌');
                return;
            }
            
            const dataStr = JSON.stringify(lastResult, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `analysis-parameters-${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            updateQueryInfo();

            const queryParams = getQueryParams();
            const textarea = document.getElementById('parameters');

            if (Object.keys(queryParams).length > 0) {
                setTimeout(() => {
                    loadFromQuery();
                }, 100);
            } else {
                // No parameters => empty textarea
                textarea.value = '';
            }

            // Add real-time event listener
            textarea.addEventListener('input', scheduleProcessing);
        });

        // Handle keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'k':
                        e.preventDefault();
                        clearResults();
                        break;
                    case 'l':
                        e.preventDefault();
                        loadFromQuery();
                        break;
                }
            }
        });

        // Update query params info if URL changes
        window.addEventListener('popstate', function() {
            updateQueryInfo();
        });
    </script>
</body>
</html>